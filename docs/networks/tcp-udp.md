---
sidebar_position: 5
---

# TCP и UDP

Транспортные протоколы стека TCP/IP.

## Сравнение TCP и UDP

| Характеристика | TCP | UDP |
|----------------|-----|-----|
| Соединение | С установлением | Без соединения |
| Надёжность | Гарантия доставки | Без гарантий |
| Порядок | Сохраняется | Не гарантируется |
| Контроль потока | Есть | Нет |
| Контроль перегрузки | Есть | Нет |
| Заголовок | 20-60 байт | 8 байт |
| Скорость | Медленнее | Быстрее |

## TCP (Transmission Control Protocol)

### Заголовок TCP

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│          Source Port          │       Destination Port        │
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│                        Sequence Number                        │
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│                    Acknowledgment Number                      │
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│Offset│ Res │U│A│P│R│S│F│            Window                    │
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│           Checksum            │         Urgent Pointer        │
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│                    Options (if any)                           │
└─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘
```

### Флаги TCP

| Флаг | Название | Описание |
|------|----------|----------|
| **SYN** | Synchronize | Установление соединения |
| **ACK** | Acknowledge | Подтверждение |
| **FIN** | Finish | Завершение соединения |
| **RST** | Reset | Сброс соединения |
| **PSH** | Push | Немедленная передача данных |
| **URG** | Urgent | Срочные данные |

### Трёхстороннее рукопожатие (3-Way Handshake)

```
Клиент                                Сервер
   │                                     │
   │──────── SYN (seq=x) ───────────────>│
   │                                     │
   │<─────── SYN+ACK (seq=y, ack=x+1) ───│
   │                                     │
   │──────── ACK (ack=y+1) ─────────────>│
   │                                     │
   │         Соединение установлено      │
```

### Завершение соединения (4-Way Handshake)

```
Клиент                                Сервер
   │                                     │
   │──────── FIN ───────────────────────>│
   │                                     │
   │<─────── ACK ────────────────────────│
   │                                     │
   │<─────── FIN ────────────────────────│
   │                                     │
   │──────── ACK ───────────────────────>│
   │                                     │
   │         Соединение закрыто          │
```

### Состояния TCP

```
             ┌─────────────────────────────────────┐
             │                                     │
      ┌──────▼──────┐                      ┌───────┴───────┐
      │   CLOSED    │                      │    LISTEN     │
      └──────┬──────┘                      └───────┬───────┘
             │ SYN sent                            │ SYN received
      ┌──────▼──────┐                      ┌───────▼───────┐
      │  SYN_SENT   │                      │  SYN_RECEIVED │
      └──────┬──────┘                      └───────┬───────┘
             │ SYN+ACK recv                        │ ACK recv
             └──────────────┬──────────────────────┘
                     ┌──────▼──────┐
                     │ ESTABLISHED │
                     └──────┬──────┘
                            │ FIN
                     ┌──────▼──────┐
                     │   FIN_WAIT  │
                     └─────────────┘
```

### Механизмы надёжности

| Механизм | Описание |
|----------|----------|
| Sequence Numbers | Нумерация байтов для упорядочивания |
| Acknowledgments | Подтверждение полученных данных |
| Retransmission | Повторная передача потерянных сегментов |
| Checksum | Контрольная сумма для целостности |
| Window | Управление потоком (сколько данных можно отправить) |

## UDP (User Datagram Protocol)

### Заголовок UDP

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│          Source Port          │       Destination Port        │
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│            Length             │           Checksum            │
└─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘
```

Всего **8 байт** — минимальный заголовок.

### Применение UDP

| Протокол | Порт | Почему UDP |
|----------|------|------------|
| DNS | 53 | Короткие запросы, скорость |
| DHCP | 67, 68 | Broadcast, нет IP для TCP |
| TFTP | 69 | Простота |
| SNMP | 161 | Мониторинг, малые данные |
| NTP | 123 | Время критично |
| VoIP/RTP | разные | Real-time, задержка важнее потерь |
| Онлайн-игры | разные | Скорость важнее надёжности |

## Порты

### Диапазоны портов

| Диапазон | Название | Описание |
|----------|----------|----------|
| 0-1023 | Well-known | Системные, требуют root |
| 1024-49151 | Registered | Зарегистрированные IANA |
| 49152-65535 | Dynamic | Эфемерные, для клиентов |

### Популярные порты

| Порт | Протокол | Сервис |
|------|----------|--------|
| 20, 21 | TCP | FTP (данные, управление) |
| 22 | TCP | SSH |
| 23 | TCP | Telnet |
| 25 | TCP | SMTP |
| 53 | TCP/UDP | DNS |
| 67, 68 | UDP | DHCP |
| 80 | TCP | HTTP |
| 110 | TCP | POP3 |
| 143 | TCP | IMAP |
| 443 | TCP | HTTPS |
| 445 | TCP | SMB |
| 3306 | TCP | MySQL |
| 3389 | TCP | RDP |
| 5432 | TCP | PostgreSQL |

## Сокеты

Сокет = IP + порт + протокол

```
Пример TCP-соединения:
Клиент: 192.168.1.10:50234 (TCP)
Сервер: 93.184.216.34:443 (TCP)

Уникальный идентификатор соединения:
(src_ip, src_port, dst_ip, dst_port, protocol)
```

### Команды для просмотра

```bash
# Linux
netstat -tulpn
ss -tulpn

# Windows
netstat -an
```

:::tip TCP vs UDP
- Нужна надёжность (файлы, веб) → **TCP**
- Нужна скорость (видео, игры, VoIP) → **UDP**
- Нужно и то, и то → **QUIC** (UDP + надёжность на уровне приложения)
:::
