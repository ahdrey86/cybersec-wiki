---
sidebar_position: 8
---

import DiffieHellman from '@site/src/components/ciphers/DiffieHellman';

# Обмен ключами

Протоколы для безопасного согласования общего секрета между сторонами.

## Диффи-Хеллман

<DiffieHellman />

## Математическая основа

### Дискретный логарифм

В циклической группе G с генератором g:
- Вычислить g^x mod p — **легко** (быстрое возведение в степень)
- Найти x по g^x mod p — **сложно** (задача дискретного логарифма)

### Протокол Диффи-Хеллмана

```
      Алиса                              Боб
        │                                  │
        │    Публичные: p, g               │
        │◄────────────────────────────────►│
        │                                  │
    a ← random                         b ← random
    A = g^a mod p                      B = g^b mod p
        │                                  │
        │───────────── A ─────────────────►│
        │◄──────────── B ──────────────────│
        │                                  │
    K = B^a mod p                      K = A^b mod p
      = g^(ab) mod p                     = g^(ab) mod p
        │                                  │
        │         Общий секрет K           │
        │◄────────────────────────────────►│
```

### Почему это работает

```
K_Alice = B^a mod p = (g^b)^a mod p = g^(ba) mod p
K_Bob   = A^b mod p = (g^a)^b mod p = g^(ab) mod p

g^(ba) = g^(ab)  →  K_Alice = K_Bob
```

## Параметры

### Выбор p

- **Простое число**
- **Достаточно большое** (минимум 2048 бит)
- **(p-1)/2 тоже простое** (safe prime)

### Выбор g

- **Генератор** циклической группы порядка q
- Порядок g должен быть большим простым числом
- Обычно g = 2 или небольшое число

### Стандартные группы (RFC 3526)

| Группа | Размер p | Безопасность |
|--------|----------|--------------|
| Group 14 | 2048 бит | ~112 бит |
| Group 15 | 3072 бит | ~128 бит |
| Group 16 | 4096 бит | ~152 бит |
| Group 18 | 8192 бит | ~192 бит |

## Уязвимости

### Man-in-the-Middle (MITM)

Без аутентификации злоумышленник может перехватить обмен и установить отдельные секреты с обеими сторонами.

**Защита:**
- Цифровые сертификаты (PKI)
- Предварительно известные ключи
- Аутентифицированный DH (Station-to-Station)

### Small Subgroup Attack

Атака на неправильно выбранные параметры группы.

**Защита:** Проверка принадлежности к правильной подгруппе.

## ECDH (Elliptic Curve DH)

Диффи-Хеллман на эллиптических кривых — меньшие ключи при той же безопасности.

| Безопасность | DH | ECDH |
|--------------|-----|------|
| 128 бит | 3072 бит | 256 бит |
| 256 бит | 15360 бит | 512 бит |

### Популярные кривые

| Кривая | Размер | Использование |
|--------|--------|---------------|
| P-256 | 256 бит | TLS, общее |
| Curve25519 | 256 бит | Signal, WireGuard, TLS 1.3 |
| P-384 | 384 бит | Высокая безопасность |

## Применение

- **TLS 1.3** — обязательный ECDHE
- **SSH** — curve25519-sha256
- **Signal** — X3DH + Double Ratchet
- **WireGuard** — Curve25519
- **IPsec** — IKEv2 с DH/ECDH

## Реализация

### Python

```python
from cryptography.hazmat.primitives.asymmetric.x25519 import X25519PrivateKey

private_key = X25519PrivateKey.generate()
public_key = private_key.public_key()
shared_secret = private_key.exchange(peer_public_key)
```

### OpenSSL

```bash
openssl genpkey -algorithm X25519 -out key.pem
```
