---
sidebar_position: 3
---

import MagmaSBox from '@site/src/components/ciphers/MagmaSBox';
import GammaCipher from '@site/src/components/ciphers/GammaCipher';

# ГОСТ «Магма» (ГОСТ Р 34.12-2015)

**Магма** — российский блочный шифр, стандартизированный в ГОСТ Р 34.12-2015. Является модернизацией ГОСТ 28147-89.

## История

| Год | Событие |
|-----|---------|
| 1989 | ГОСТ 28147-89 — первый советский стандарт |
| 2015 | ГОСТ Р 34.12-2015 — стандартизация «Магма» и «Кузнечик» |
| 2016 | ГОСТ Р 34.13-2015 — режимы работы |

## Параметры

| Параметр | Значение |
|----------|----------|
| Размер блока | 64 бита |
| Размер ключа | 256 бит |
| Число раундов | 32 |
| Структура | Сеть Фейстеля |

## Структура раунда

Каждый раунд использует функцию **g**:

```
         L (32 бит)     R (32 бит)
              │              │
              │    ┌─────┐   │
              │    │ Kᵢ  │   │
              │    └──┬──┘   │
              │       │      │
              │    ┌──┴──┐   │
              └───►│  +  │◄──┘
                   └──┬──┘
                      │
                   ┌──┴──┐
                   │  S  │  ← S-блок (8 × 4-битных)
                   └──┬──┘
                      │
                   ┌──┴──┐
                   │ <<<11│  ← Циклический сдвиг влево
                   └──┬──┘
                      │
                   ┌──┴──┐
              ┌───►│ XOR │
              │    └──┬──┘
              │       │
              │       ▼
         новый R   новый L
```

## S-блок замены

S-блок Магмы состоит из 8 таблиц замены 4→4 бита:

<MagmaSBox />

### Таблицы S-блока (id-tc26-gost-28147-param-Z)

```
S₀: 12  4  6  2 10  5 11  9 14  8 13  7  0  3 15  1
S₁:  6  8  2  3  9 10  5 12  1 14  4  7 11 13  0 15
S₂: 11  3  5  8  2 15 10 13 14  1  7  4 12  9  6  0
S₃: 12  8  2  1 13  4 15  6  7  0 10  5  3 14  9 11
S₄:  7 15  5 10  8  1  6 13  0  9  3 14 11  4  2 12
S₅:  5 13 15  6  9  2 12 10 11  7  8  1  4  3 14  0
S₆:  8 14  2  5  6  9  1 12 15  4 11  0 13 10  3  7
S₇:  1  7 14 13  0  5  8  3  4 15 10  6  9 12 11  2
```

## Функция g (преобразование t)

```python
def magma_t(a: int, sbox: list) -> int:
    """S-блок замены + циклический сдвиг"""
    result = 0
    for i in range(8):
        nibble = (a >> (i * 4)) & 0xF
        substituted = sbox[i][nibble]
        result |= (substituted << (i * 4))
    
    # Циклический сдвиг влево на 11 бит
    return ((result << 11) | (result >> 21)) & 0xFFFFFFFF

def magma_g(a: int, k: int, sbox: list) -> int:
    """Функция g: сложение с ключом + t"""
    return magma_t((a + k) & 0xFFFFFFFF, sbox)
```

## Раундовая функция

```python
def magma_round(left: int, right: int, key: int, sbox: list) -> tuple:
    """Один раунд Магмы"""
    new_left = right
    new_right = left ^ magma_g(right, key, sbox)
    return (new_left, new_right)
```

## Расписание ключей

256-битный ключ разбивается на 8 подключей по 32 бита:

```
K = K₀ || K₁ || K₂ || K₃ || K₄ || K₅ || K₆ || K₇
```

Порядок использования в раундах:

```
Раунды  1-8:   K₀, K₁, K₂, K₃, K₄, K₅, K₆, K₇
Раунды  9-16:  K₀, K₁, K₂, K₃, K₄, K₅, K₆, K₇
Раунды 17-24:  K₀, K₁, K₂, K₃, K₄, K₅, K₆, K₇
Раунды 25-32:  K₇, K₆, K₅, K₄, K₃, K₂, K₁, K₀  (обратный порядок)
```

## Полная реализация на Python

```python
# S-блоки id-tc26-gost-28147-param-Z
MAGMA_SBOX = [
    [12, 4, 6, 2, 10, 5, 11, 9, 14, 8, 13, 7, 0, 3, 15, 1],
    [6, 8, 2, 3, 9, 10, 5, 12, 1, 14, 4, 7, 11, 13, 0, 15],
    [11, 3, 5, 8, 2, 15, 10, 13, 14, 1, 7, 4, 12, 9, 6, 0],
    [12, 8, 2, 1, 13, 4, 15, 6, 7, 0, 10, 5, 3, 14, 9, 11],
    [7, 15, 5, 10, 8, 1, 6, 13, 0, 9, 3, 14, 11, 4, 2, 12],
    [5, 13, 15, 6, 9, 2, 12, 10, 11, 7, 8, 1, 4, 3, 14, 0],
    [8, 14, 2, 5, 6, 9, 1, 12, 15, 4, 11, 0, 13, 10, 3, 7],
    [1, 7, 14, 13, 0, 5, 8, 3, 4, 15, 10, 6, 9, 12, 11, 2]
]

def magma_encrypt_block(block: int, key: bytes) -> int:
    """Шифрование одного 64-битного блока"""
    # Разбиваем ключ на подключи
    subkeys = [int.from_bytes(key[i:i+4], 'little') for i in range(0, 32, 4)]
    
    # Расписание ключей
    key_schedule = subkeys * 3 + subkeys[::-1]
    
    # Разбиваем блок на L и R
    left = block >> 32
    right = block & 0xFFFFFFFF
    
    # 32 раунда
    for i in range(32):
        left, right = right, left ^ magma_g(right, key_schedule[i], MAGMA_SBOX)
    
    # Финальный swap
    return (left << 32) | right

def magma_decrypt_block(block: int, key: bytes) -> int:
    """Дешифрование одного блока"""
    subkeys = [int.from_bytes(key[i:i+4], 'little') for i in range(0, 32, 4)]
    key_schedule = subkeys + subkeys[::-1] * 3  # Обратный порядок
    
    left = block >> 32
    right = block & 0xFFFFFFFF
    
    for i in range(32):
        left, right = right, left ^ magma_g(right, key_schedule[i], MAGMA_SBOX)
    
    return (left << 32) | right
```

## Режимы работы (ГОСТ Р 34.13-2015)

| Режим | Обозначение | Описание |
|-------|-------------|----------|
| ECB | Простая замена | Независимое шифрование блоков |
| CTR | Гаммирование | Потоковый режим с счётчиком |
| OFB | Гаммирование с ОС | Потоковый с обратной связью |
| CBC | Сцепление | Зависимость от предыдущего блока |
| CFB | Гаммирование с ОС по шифротексту | Самосинхронизирующийся |
| MAC | Имитовставка | Код аутентификации |

## Гаммирование (режим CTR)

<GammaCipher />

### Принцип гаммирования

```
Гамма = E(IV) || E(IV+1) || E(IV+2) || ...
Шифротекст = Открытый текст XOR Гамма
```

```python
def magma_ctr(data: bytes, key: bytes, iv: bytes) -> bytes:
    """Режим гаммирования (CTR)"""
    result = bytearray()
    counter = int.from_bytes(iv, 'big')
    
    for i in range(0, len(data), 8):
        # Генерируем гамму
        gamma = magma_encrypt_block(counter, key)
        gamma_bytes = gamma.to_bytes(8, 'big')
        
        # XOR с данными
        block = data[i:i+8]
        for j in range(len(block)):
            result.append(block[j] ^ gamma_bytes[j])
        
        counter += 1
    
    return bytes(result)
```

## Сравнение Магма и Кузнечик

| Параметр | Магма | Кузнечик |
|----------|-------|----------|
| Блок | 64 бит | 128 бит |
| Ключ | 256 бит | 256 бит |
| Раунды | 32 | 10 |
| Структура | Сеть Фейстеля | SP-сеть |
| Год | 1989/2015 | 2015 |

## Криптостойкость

- Нет известных практических атак
- Теоретические атаки требуют 2^64 данных (ограничение размера блока)
- Рекомендуется Кузнечик для новых систем

:::info Применение
Магма используется для совместимости с ГОСТ 28147-89. Для новых разработок рекомендуется ГОСТ «Кузнечик» с 128-битным блоком.
:::
